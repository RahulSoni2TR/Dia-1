<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estimate Page</title>
    <link rel="stylesheet" href="get_estimate_style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/vfs_fonts.js"></script>

</head>
<body>
<div class="top-right-nav">
        <a href="/logout" class="logout-btn">Logout</a>
    </div>
<div class="container">
    <h1>Please update the product name</h1>
    <table class="estimate-table">
        <thead>
            <tr>
                <th class="description">Description</th>
                <th>Qty</th>
                <th>Rate</th>
                <th>Amount</th>
            </tr>
        </thead>
        <tbody>
            <tr id="gold_row">
    <td class="description">Gold</td>
    <td id="gold-qty">17.000</td>
    <td id="gold-rate"></td>
    <td id="gold-amt">115175</td>
</tr>
            <tr id="labour_row">
                <td class="description">Labour</td>
                <td id="labour-qty">17.000</td>
                <td id="labour-rate">1100</td>
                <td id="labour-amt">18700</td>
            </tr>
            <tr id="stones_row">
                <td class="description">Stones</td>
                <td id="stone-qty">160</td>
                <td id="stone-rate">150</td>
                <td id="stone-amt">24000</td>
            </tr>
            <tr id="beads_row">
                <td class="description">Beads</td>
                <td id="beads-qty">48.15</td>
                <td id="beads-rate">60</td>
                <td id="beads-amt">2889</td>
            </tr>
            <tr id="pearls_row">
                <td class="description">Pearls</td>
                <td id="pearls-qty">9.150</td>
                <td id="pearls-rate">1200</td>
                <td id="pearls-amt">10980</td>
            </tr>
            <tr id="sspearls_row">
                <td class="description">SS Pearls</td>
               <td id="sspearls-qty">0</td>
                <td id="sspearls-rate">0</td>
                <td id="sspearls-amt">0</td>
            </tr>
                        <tr id="diamonds_row">
                <td class="description">Diamonds</td>
               <td id="diamonds-qty">0</td>
                <td id="diamonds-rate">0</td>
                <td id="diamonds-amt">0</td>
            </tr>
            <tr id="os_row">
                <td class="description">Other Stones</td>
               <td id="ostones-qty">0</td>
                <td id="ostones-rate">0</td>
                <td id="ostones-amt">0</td>
            </tr>
            <tr id="vilandi_row">
                <td class="description">Vilandi</td>
               <td id="vilandi-qty">0</td>
                <td id="vilandi-rate">0</td>
                <td id="vilandi-amt">0</td>
            </tr>
            <tr id="moz_row">
                <td class="description">Mozonite</td>
                <td id="mozo-qty">0</td>
                <td id="mozo-rate">0</td>
                <td id="mozo-amt">0</td>
            </tr>
            <tr id="realSt_row">
                <td class="description">Real St</td>
                <td id="realSt-qty"></td>
                <td id="realSt-rate"></td>
                <td id="realSt-amt">3000</td>
            </tr>
            <tr id="fitting_row">
                <td class="description">Fitting</td>
                <td id="fitting-qty"></td>
                <td id="fitting-rate"></td>
                <td id="fitting-amt">1500</td>
            </tr>
            <tr id="gst_row">
                <td class="description">GST 3%</td>
                <td id="gst-qty"></td>
                <td id="gst-rate"></td>
                <td id="gst-amt">5197</td>
            </tr>
            <tr id="total_row" class="total-row">
                <td class="description">Total</td>
                <td id="total-qty"></td>
                <td id="total-rate"></td>
                <td id="total-amt">178441</td>
            </tr>
        </tbody>
    </table>
    <button id="download-pdf" style="margin-top: 20px;">Download Estimate</button>
    <div style="margin-top: 20px; text-align: center;">
    <a href="/view-product" class="back-button">Back to View Products</a>
</div>
</div>
<script>
let estimate;
let product;
let rate;
    document.addEventListener("DOMContentLoaded", function() {
    	const productId = sessionStorage.getItem('productId');
        // Replace `1` with the actual product ID you want to fetch.
        fetch(`/getEstimate/${productId}`)
            .then(response => response.json())
            .then(data => {
                product = data.object1;
                estimate = data.object2;
                rate = data.object3;
                console.log(rate);
                const productKarat = product.karat;
                const formattedKarat = productKarat !== null ? productKarat.toFixed(2) : "0.00";
                const goldRate = rate.find(item => item.commodity === formattedKarat)?.price || 0;
                const adjustedgoldRate= goldRate/10;
                // Populate table cells based on the `estimate` fields
                 const titleElement = document.querySelector('h1');
            	titleElement.textContent = `Estimate for ${product.item}`;
                document.getElementById("gold-qty").textContent = product.net ?? 0;
                document.getElementById("gold-rate").textContent = `₹ ${adjustedgoldRate ?? 0}`;
                document.getElementById("gold-amt").textContent = `₹ ${estimate.gold ?? 0}`;
                document.getElementById("labour-qty").textContent = product.net ?? 0;
                document.getElementById("labour-rate").textContent = `₹ ${product.labour ?? 0}`;
                document.getElementById("labour-amt").textContent = `₹ ${estimate.labour ?? 0}`;
                document.getElementById("vilandi-qty").textContent = product.vilandiCt ?? 0;
                document.getElementById("vilandi-rate").textContent = `₹ ${product.vRate ?? 0}`;
                document.getElementById("vilandi-amt").textContent = `₹ ${estimate.vilandi ?? 0}`;
                document.getElementById("stone-qty").textContent = product.stones ?? 0;
                document.getElementById("stone-rate").textContent = `₹ ${product.stRate ?? 0}`;
                document.getElementById("stone-amt").textContent = `₹ ${estimate.stones ?? 0}`;
                document.getElementById("beads-qty").textContent = product.beadsCt ?? 0;
                document.getElementById("beads-rate").textContent = `₹ ${product.bdRate ?? 0}`;
                document.getElementById("beads-amt").textContent = `₹ ${estimate.beads ?? 0}`;
                document.getElementById("pearls-qty").textContent = product.pearlsGm ?? 0;
                document.getElementById("pearls-rate").textContent = `₹ ${product.prlRate ?? 0}`;
                document.getElementById("pearls-amt").textContent = `₹ ${estimate.pearls ?? 0}`;
                document.getElementById("sspearls-qty").textContent = product.ssPearlCt ?? 0;
                document.getElementById("sspearls-rate").textContent = `₹ ${product.ssRate ?? 0}`;
                document.getElementById("sspearls-amt").textContent = `₹ ${estimate.ssPearls ?? 0}`;
                document.getElementById("mozo-qty").textContent = `₹ ${product.mozonite ?? 0}`;
                document.getElementById("mozo-rate").textContent = `₹ ${product.mRate ?? 0}`;
                document.getElementById("mozo-amt").textContent = `₹ ${estimate.mozo ?? 0}`;
                document.getElementById("diamonds-qty").textContent = `₹ ${product.diamondsCt ?? 0}`;
                document.getElementById("diamonds-rate").textContent = `₹ ${product.diaRt ?? 0}`;
            	document.getElementById("diamonds-amt").textContent = `₹ ${estimate.diamonds ?? 0}`;
                document.getElementById("ostones-qty").textContent = `₹ ${product.otherStonesCt ?? 0}`;
                document.getElementById("ostones-rate").textContent = `₹ ${product.otherStonesRt ?? 0}`;
            	document.getElementById("ostones-amt").textContent = `₹ ${estimate.otherStones ?? 0}`;
                document.getElementById("realSt-amt").textContent = `₹ ${product.realStone ?? 0}`;
                document.getElementById("fitting-amt").textContent = `₹ ${estimate.fitting ?? 0}`;
           document.getElementById("gst-amt").textContent = `₹ ${estimate.gst ?? 0}`;
                document.getElementById("total-amt").textContent = `₹ ${estimate.total ?? 0}`;
                
                const categoryId = product.categoryId;
                console.log("Category ID:", categoryId);
                function showHideRows(categoryId) {
                    const rowsToHide = {
                        1: ["gold_row", "labour_row", "diamonds_row", "os_row", "gst_row", "total_row"],
                        2: ["gold_row", "labour_row", "beads_row", "pearls_row", "diamonds_row", "os_row", "vilandi_row", "gst_row", "fitting_row", "total_row"],
                        3: ["gold_row", "labour_row", "gst_row", "total_row"],
                        4: ["gold_row", "diamonds_row", "os_row", "labour_row", "gst_row", "total_row"],
                        5: ["labour_row", "gold_row", "stones_row", "beads_row", "pearls_row", "sspearls_row", "vilandi_row", "moz_row", "realSt_row", "fitting_row", "gst_row", "total_row"],
                        6: ["gold_row", "labour_row", "stones_row", "beads_row", "pearls_row", "sspearls_row", "moz_row", "realSt_row", "fitting_row", "gst_row", "total_row"]
                    };

                    // Hide all rows first
                    const allRows = document.querySelectorAll('tr');
                    allRows.forEach(row => row.style.display = 'none');

                    // Show rows for the selected category
                    const rowsToDisplay = rowsToHide[categoryId];
                    rowsToDisplay.forEach(rowId => {
                        const row = document.getElementById(rowId);
                        if (row) row.style.display = 'table-row';
                    });
                }

                // Call the function to show the appropriate rows
                showHideRows(categoryId);
            })
            .catch(error => console.error('Error fetching estimate:', error));
    });
    
    document.getElementById("download-pdf").addEventListener("click", function () {
        // Extract the title and table content
        const title = document.querySelector("h1").textContent;
        const table = document.querySelector(".estimate-table");

        // Create table data for pdfMake
        const headers = [];
        const rows = [];

        // Add headers (thead content)
        const headerCells = table.querySelectorAll("thead th");
        headerCells.forEach((cell) => headers.push({ text: cell.textContent, bold: true, alignment: 'center', fillColor: '#f2f2f2' }));

        // Add rows (tbody content)
        const tableRows = table.querySelectorAll("tbody tr");
        tableRows.forEach((row, index) => {
            const rowData = [];
            row.querySelectorAll("td").forEach((cell) => {
                rowData.push({ 
                    text: cell.textContent, 
                    alignment: 'center', 
                    fillColor: index % 2 === 0 ? '#ffffff' : '#f9f9f9' // Alternate row colors
                });
            });
            rows.push(rowData);
        });

        // Define PDF content
        const docDefinition = {
            content: [
                // Header Section
                {
                    columns: [
                        { 
                            text: 'Your Company Name', 
                            bold: true, 
                            fontSize: 18, 
                            alignment: 'left', 
                            margin: [0, 0, 0, 10] 
                        },
                        { 
                            text: `Estimate of ${product.item}`, 
                            bold: true, 
                            fontSize: 22, 
                            alignment: 'right', 
                            margin: [0, 0, 0, 10] 
                        }
                    ]
                },
                {
                    text: `Prepared for: Customer Name\nDate: ${new Date().toLocaleDateString()}`,
                    margin: [0, 0, 0, 20]
                },
                {
                    table: {
                        headerRows: 1,
                        widths: ['40%', '20%', '20%', '20%'], // Adjust column widths as needed
                        body: [headers, ...rows],
                    },
                    layout: {
                        hLineWidth: function () { return 0.5; },
                        vLineWidth: function () { return 0.5; },
                        hLineColor: function () { return '#cccccc'; }, // Subtle border colors
                        vLineColor: function () { return '#cccccc'; },
                        paddingLeft: function () { return 8; }, // Padding for better readability
                        paddingRight: function () { return 8; },
                        paddingTop: function () { return 5; },
                        paddingBottom: function () { return 5; },
                    },
                },
                // Summary Section
                {
                    text: 'Summary',
                    bold: true,
                    fontSize: 16,
                    margin: [0, 20, 0, 10]
                },
                {
                    table: {
                        widths: ['70%', '30%'],
                        body: [
                            [
                                { text: 'Total Amount', bold: true, alignment: 'right', margin: [0, 0, 10, 0] },
                                { text: `₹ ${estimate.nogsttotal.toFixed(2) ?? 0}`, bold: true, alignment: 'right', fillColor: '#f2f2f2' }
                            ],
                            [
                                { text: 'GST (3%)', alignment: 'right', margin: [0, 0, 10, 0] },
                                { text: `₹ ${estimate.gst ?? 0}`, alignment: 'right', fillColor: '#f9f9f9' }
                            ],
                            [
                                { text: 'Grand Total', bold: true, alignment: 'right', margin: [0, 0, 10, 0] },
                                { text: `₹ ${estimate.total.toFixed(2) ?? 0}`, bold: true, alignment: 'right', fillColor: '#f2f2f2' }
                            ]
                        ]
                    },
                    layout: 'noBorders'
                }
            ],
            styles: {
                header: { fontSize: 18, bold: true },
                subheader: { fontSize: 14, bold: true },
            },
            defaultStyle: {
                font: 'Roboto', // Roboto is supported by pdfMake by default
            },
        };

        // Generate and download PDF
        pdfMake.createPdf(docDefinition).download("Estimate.pdf");
    });


</script>

</body>
</html>
