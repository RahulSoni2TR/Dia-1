<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modify Product</title>
    <link rel="stylesheet" href="modify_product_style.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="top-right-nav">
        <a href="/logout" class="logout-btn">Logout</a>
    </div>
    <div class="container">
        <h1>Modify Product</h1>
        <form id="productForm" enctype="multipart/form-data" onsubmit="submitForm(event)" method="POST">
            <label for="productId">Enter Design No. to Modify:</label>
            <input type="text" id="productId" name="productId" step="any" required>

            <button type="button" class="load-button" onclick="loadProductDetails()">Load Product Details</button>

            <div id="productDetails" class="product-details" style="display: none;">
                <label for="productName">Product Name:</label>
                <input type="text" id="productName" name="productName" required>

                <label for="productPrice">Price:</label>
                <input type="text" id="productPrice" name="productPrice" step="any" required>

                <label for="productRemarks">Remarks:</label>
                <textarea id="productRemarks" name="productRemarks"></textarea>

                <label for="productImageUrl">Image URL:</label>
                <input type="text" id="productImageUrl" name="productImageUrl" onchange="updateImagePreview()" readonly>
                <button type="button" id="uploadImageButton" onclick="document.getElementById('imageFileInput').click()">Select Image</button>
                <input type="file" id="imageFileInput" name="image" style="display: none;" accept="image/*" onchange="uploadImage()">
                <img id="imagePreview" src="" alt="Image Preview" style="display: none; width: 200px;"/>

                <label for="categoryId">Category ID:</label>
                <select id="categoryId" name="categoryId" onchange="updateCategoryFields()">
                    <option value="">Select Category</option>
                    <option value="1">Diamond Rings</option>
                    <option value="2">Open Setting</option>
                    <option value="3">Chains</option>
                    <option value="4">Diamond Earrings</option>
                    <option value="5">Vilandi</option>
                    <option value="6">Jadtar Register</option>
                </select>

                <!-- Common fields for all categories -->
                <div id="commonFields">
                    <label for="productNet">Net:</label>
                    <input type="text" id="productNet" name="productNet" step="any">
                </div>

                <!-- Category-specific fields -->
                <div id="categoryFields" style="display: none;">
                    <div id="diamondRingsFields" class="category-specific" style="display: none;">
                        <label for="designNoDR">Design No:</label>
                        <input type="text" id="designNoDR" name="designNoDR" step="any">
                        <label for="pcs">Pieces:</label>
                        <input type="number" id="pcs" name="pcs" step="any">
                        <label for="diaWeight">Diamond Weight:</label>
                        <input type="text" id="diaWeight" name="diaWeight" step="any">
                    </div>

                    <div id="openSettingFields" class="category-specific" style="display: none;">
                        <label for="designNoOS">Design No:</label>
                        <input type="text" id="designNoOS" name="designNoOS" step="any">
                        <label for="gross">Gross:</label>
                        <input type="number" id="gross" name="gross" step="any">
                        <label for="vilandiCt">Vilandi CT:</label>
                        <input type="number" id="vilandiCt" name="vilandiCt" step="any">
                        <label for="vilandiRate">Vilandi Rate:</label>
                        <input type="number" id="vilandiRate" name="vilandiRate" step="any">
                        <label for="diamondsCt">Diamonds Count:</label>
                        <input type="number" id="diamondsCt" name="diamondsCt" step="any">
                        <label for="beadsCt">Beads(Ct.):</label>
                        <input type="number" id="beadsCt" name="beadsCt" step="any">
                        <label for="beadsRate">Beads Rate:</label>
                        <input type="number" id="beadsRate" name="beadsRate" step="any">
                        <label for="pearlsGm">Pearls(gm):</label>
                        <input type="text" id="pearlsGm" name="pearlsGm" step="any">
                        <label for="openPearlsRate">Pearls Rate:</label>
                        <input type="number" id="openPearlsRate" name="openPearlsRate" step="any">
                        <label for="otherStonesCt">Other Stones(Ct.):</label>
                        <input type="number" id="otherStonesCt" name="otherStonesCt" step="any">
                        <label for="others">Others:</label>
                        <input type="text" id="others" name="others" step="any">
                    </div>

                    <div id="chainsFields" class="category-specific" style="display: none;">
                        <label for="designNo">Design No:</label>
                        <input type="text" id="designNo" name="designNo" step="any">
                    </div>

                    <div id="diamondEarringsFields" class="category-specific" style="display: none;">
                        <label for="designNoEarrings">Design No:</label>
                        <input type="text" id="designNoEarrings" name="designNoEarrings" step="any">
                        <label for="pcsEarrings">Pieces:</label>
                        <input type="number" id="pcsEarrings" name="pcsEarrings" step="any">
                        <label for="diamondsCtEarrings">Diamonds(Ct.):</label>
                        <input type="number" id="diamondsCtEarrings" name="diamondsCtEarrings" step="any">
                    </div>

                    <div id="vilandiFields" class="category-specific" style="display: none;">
                       <label for="designNoVilandi">Design No:</label>
                        <input type="text" id="designNoVilandi" name="designNoVilandi" step="any">
                        <label for="grossVilandi">Gross:</label>
                        <input type="number" id="grossVilandi" name="grossVilandi" step="any">
<!--                         <label for="netVilandi">Net:</label>
                        <input type="number" id="netVilandi" name="netVilandi" step="any"> -->
                        <label for="vilandi">Vilandi:</label>
                        <input type="number" id="vilandi" name="vilandi" step="any">
                        <label for="vRate">Vilandi Rate:</label>
                        <input type="number" id="vRate" name="vRate" step="any">
                        <label for="stones">Stones:</label>
                        <input type="number" id="stones" name="stones" step="any">
                        <label for="vsRate">Stones Rate:</label>
                        <input type="number" id="vsRate" name="vsRate" step="any">
                        <label for="beadsCtVilandi">Beads(Ct.):</label>
                        <input type="number" id="beadsCtVilandi" name="beadsCtVilandi" step="any">
                        <label for="vbRate">Beads Rate:</label>
                        <input type="number" id="vbRate" name="vbRate" step="any">
                        <label for="pearlsGmVilandi">Pearls(gm):</label>
                        <input type="number" id="pearlsGmVilandi" name="pearlsGmVilandi" step="any">
                        <label for="vpRate">Pearls Rate:</label>
                        <input type="number" id="vpRate" name="vpRate" step="any">
                        <label for="ssPearlCt">SS Pearls(Ct.):</label>
                        <input type="number" id="ssPearlCt" name="ssPearlCt" step="any">
                        <label for="vssRate">SS Pearls Rate:</label>
                        <input type="number" id="vssRate" name="vssRate" step="any">
                        <label for="vrealStone">Real Stone:</label>
                        <input type="number" id="vrealStone" name="vrealStone" step="any">
                        <label for="vfitting">Fitting:</label>
                        <input type="number" id="vfitting" name="vfitting" step="any">
                        <label for="vmoz">Mozonite:</label>
                        <input type="number" id="vmoz" name="vmoz" step="any">
                         <label for="vmRate">Mozonite Rate:</label>
                        <input type="number" id="vmRate" name="vmRate" step="any"> 
                    </div>

                    <div id="jadtarFields" class="category-specific" style="display: none;">
                         <label for="designNoJadtar">Design No:</label>
                        <input type="text" id="designNoJadtar" name="designNoJadtar" step="any">  
                        <label for="grossJadtar">Gross:</label>
                        <input type="number" id="grossJadtar" name="grossJadtar" step="any">
                   <!--      <label for="netJadtar">Net:</label>
                        <input type="number" id="netJadtar" name="netJadtar" step="any"> -->
                        <label for="stonesJadtar">Stones:</label>
                        <input type="number" id="stonesJadtar" name="stonesJadtar" step="any">
                        <label for="jsRate">Stones Rate:</label>
                        <input type="number" id="jsRate" name="jsRate" step="any">
                        <label for="beadsCtJadtar">Beads(Ct.):</label>
                        <input type="number" id="beadsCtJadtar" name="beadsCtJadtar" step="any">
                        <label for="jbRate">Beads Rate:</label>
                        <input type="number" id="jbRate" name="jbRate" step="any">
                        <label for="pearlsGmJadtar">Pearls(gm):</label>
                        <input type="number" id="pearlsGmJadtar" name="pearlsGmJadtar" step="any">
                         <label for="jpRate">Pearls Rate:</label>
                        <input type="number" id="jpRate" name="jpRate" step="any">
                        <label for="ssPearlCtJadtar">SS Pearl(Ct.):</label>
                        <input type="number" id="ssPearlCtJadtar" name="ssPearlCtJadtar" step="any">
                        <label for="jssRate">SS Pearls Rate:</label>
                        <input type="number" id="jssRate" name="jssRate" step="any">
                        <label for="realStoneJadtar">Real Stone:</label>
                        <input type="number" id="realStoneJadtar" name="realStoneJadtar" step="any">
                        <label for="jfitting">Fitting:</label>
                        <input type="number" id="jfitting" name="jfitting" step="any">
                         <label for="jmoz">Mozonite:</label>
                        <input type="number" id="jmoz" name="jmoz" step="any">
                         <label for="jmRate">Mozonite Rate:</label>
                        <input type="number" id="jmRate" name="jmRate" step="any">
                    </div>
                </div>
            </div>
           
            <button type="submit" class="submit-button">Modify Product</button>
        </form>
        <a href="/home" class="back-button">Back to Home</a>
    </div>

 <div id="notificationModal" class="modal">
        <div id="modalContent" class="modal-content">
            <h2 id="modalTitle"></h2>
            <p id="modalMessage"></p>
            <button class="close-btn">OK</button>
        </div>
    </div>
    <script>
    function loadProductDetails() {
        const productId = document.getElementById('productId').value;

        fetch(`/loadProduct/${productId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Product not found');
                }
                return response.json();
            })
            .then(product => {
                document.getElementById('productName').value = product.item;
                document.getElementById('productPrice').value = product.price.toFixed(2);
                document.getElementById('productRemarks').value = product.remarks;
                document.getElementById('productNet').value = product.net;
                document.getElementById('productImageUrl').value = product.imageUrl;
                updateImagePreview();

                const categoryId = product.categoryId;
                document.getElementById('categoryId').value = categoryId;
                updateCategoryFields();

                // Populate category-specific fields based on category
                if (categoryId === 1) { // Diamond Rings
                	document.getElementById('designNoDR').value = product.designNo; 
                    document.getElementById('pcs').value = product.pcs;
                    document.getElementById('diaWeight').value = product.diamondsCt;
                } else if (categoryId === 2) { // Open Setting
                	document.getElementById('designNoOS').value = product.designNo; 
                    document.getElementById('gross').value = product.gross;
                    document.getElementById('vilandiCt').value = product.vilandiCt;
                    document.getElementById('vilandiRate').value = product.vRate;
                    document.getElementById('diamondsCt').value = product.diamondsCt;
                    document.getElementById('beadsCt').value = product.beadsCt;
                    document.getElementById('beadsRate').value = product.bdRate;
                    document.getElementById('pearlsGm').value = product.pearlsGm;
                    document.getElementById('openPearlsRate').value = product.prlRate;
                    document.getElementById('otherStonesCt').value = product.otherStonesCt;
                    document.getElementById('others').value = product.others;
                } else if (categoryId === 3) { // Chains
                     document.getElementById('designNo').value = product.designNo; 
                } else if (categoryId === 4) { // Diamond Earrings
                     document.getElementById('designNoEarrings').value = product.designNo; 
                    document.getElementById('pcsEarrings').value = product.pcs;
                    document.getElementById('diamondsCtEarrings').value = product.diamondsCt;
                } else if (categoryId === 5) { // Vilandi
                    document.getElementById('designNoVilandi').value = product.designNo; 
                    document.getElementById('vilandi').value = product.vilandiCt;
                    document.getElementById('vRate').value = product.vRate;
                    document.getElementById('grossVilandi').value = product.gross;
                  /*   document.getElementById('netVilandi').value = product.net; */
                    document.getElementById('stones').value = product.stones;
                    document.getElementById('vsRate').value = product.stRate;
                    document.getElementById('beadsCtVilandi').value = product.beadsCt;
                    document.getElementById('vbRate').value = product.vRate;
                    document.getElementById('pearlsGmVilandi').value = product.pearlsGm;
                    document.getElementById('vpRate').value = product.prlRate;
                    document.getElementById('ssPearlCt').value = product.ssPearlCt;
                    document.getElementById('vssRate').value = product.ssRate;
                    document.getElementById('vrealStone').value = product.realStone;
                    document.getElementById('vfitting').value = product.fitting;
                    document.getElementById('vmoz').value = product.mozonite;
                    document.getElementById('vmRate').value = product.mRate;
                } else if (categoryId === 6) { // Jadtar Register
                     document.getElementById('designNoJadtar').value = product.designNo; 
                    document.getElementById('grossJadtar').value = product.gross;
                    /* document.getElementById('netJadtar').value = product.net; */
                    document.getElementById('stonesJadtar').value = product.stones;
                    document.getElementById('beadsCtJadtar').value = product.beadsCt;
                    document.getElementById('pearlsGmJadtar').value = product.pearlsGm;
                    document.getElementById('ssPearlCtJadtar').value = product.ssPearlCt;
                    document.getElementById('realStoneJadtar').value = product.realStone;
                    document.getElementById('jsRate').value = product.stRate;
                    document.getElementById('jbRate').value = product.bdRate;
                    document.getElementById('jpRate').value = product.prlRate;
                    document.getElementById('jssRate').value = product.ssRate;
                    document.getElementById('jfitting').value = product.fitting;
                    document.getElementById('jmoz').value = product.mozonite;
                    document.getElementById('jmRate').value = product.mRate;
                }

                document.getElementById('productDetails').style.display = 'block'; // Show details
            })
            .catch(error => {
                alert(error.message);
                document.getElementById('productDetails').style.display = 'none'; // Hide details if error
            });
    }

        function updateImagePreview() {
            const imageUrl = document.getElementById('productImageUrl').value;
            const imagePreview = document.getElementById('imagePreview');

            if (imageUrl) {
                imagePreview.src = imageUrl;
                imagePreview.style.display = 'block'; // Show the image
            } else {
                imagePreview.style.display = 'none'; // Hide the image if URL is empty
            }
        }

        function uploadImage() {
            const fileInput = document.getElementById('imageFileInput');
            const file = fileInput.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('productImageUrl').value = event.target.result; // Set the image URL to the base64 data
                    updateImagePreview(); // Update the preview
                };
                reader.readAsDataURL(file); // Convert the file to base64
            }
        }

        function updateCategoryFields() {
            const categoryId = document.getElementById('categoryId').value;

            // Hide all category-specific fields
            const categoryFields = document.querySelectorAll('.category-specific');
            categoryFields.forEach(field => field.style.display = 'none');

            // Show the relevant category fields
            if (categoryId) {
                document.getElementById('categoryFields').style.display = 'block';
                const selectedFields = {
                    1: 'diamondRingsFields',
                    2: 'openSettingFields',
                    3: 'chainsFields',
                    4: 'diamondEarringsFields',
                    5: 'vilandiFields',
                    6: 'jadtarFields',
                };
                document.getElementById(selectedFields[categoryId]).style.display = 'block';
            }
        }

        function showModal(title, message, isSuccess) {
            const modal = $("#notificationModal");
            const modalContent = $("#modalContent");

            // Update modal content and styling
            if (title && message) { // Ensure title and message are not empty
                $("#modalTitle").text(title);
                $("#modalMessage").text(message);
                modalContent.removeClass("modal-success modal-error");
                modalContent.addClass(isSuccess ? "modal-success" : "modal-error");

                // Show the modal
                modal.fadeIn(); // Show the modal with fadeIn

                // Bind the close button click event here
                $(".close-btn").off("click").on("click", function () {
                    modal.fadeOut(); // Hide the modal when clicking the "OK" button
                    $("#modalTitle").text(""); // Clear the title
                    $("#modalMessage").text(""); // Clear the message
                });
            } else {
                console.warn("Modal content is missing. Title or message is empty.");
            }
        }

        $(".close-btn").on("click", function () {
            $("#notificationModal").fadeOut(); // Hide the modal when clicking the "OK" button
            $("#modalTitle").text(""); // Clear the title
            $("#modalMessage").text(""); // Clear the message
        });

        
        function submitForm(event) {
            event.preventDefault(); // Prevent default form submission

            const form = document.getElementById('productForm');
            const formData = new FormData(form);
            const Id = encodeURIComponent(formData.get('productId'));
			/* console.log(formData.get('designNo'));
			console.log(formData.get('designNoVilandi'));	 */		
            $.ajax({
                url: `/updateProduct/${Id}`,
                type: 'PUT',
                data: formData,
                contentType: false, // Set to false to tell jQuery not to set the Content-Type header
                processData: false, // Prevent jQuery from automatically transforming the data into a query string
                success: function (data) {
                    showModal("Success", "Product updated successfully!", true);

                    // Clear form after success
                    $("#productForm")[0].reset();
                    $("#dynamicFields").empty();

                    // Attach redirect logic to the OK button
                    $(".close-btn").off("click").on("click", function () {
                        $("#notificationModal").fadeOut(() => {
                            window.location.href = '/modify-product'; // Redirect after closing the modal
                        });
                    });
                },
                error: function (jqXHR, textStatus, errorThrown) {
                	console.error("AJAX Error: ", textStatus, errorThrown);
                    console.error("Response: ", jqXHR.responseText);
                    showModal("Error", "Failed to update product: " + jqXHR.responseText, false);

                    // Close modal without redirecting in error case
                    $(".close-btn").off("click").on("click", function () {
                        $("#notificationModal").fadeOut();
                    });
                }
            });
        }


    </script>
</body>
</html>
