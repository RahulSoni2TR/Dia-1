<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>User Permissions</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="permissions_style.css">

</head>
<body>
  <!-- Header with Logout Button -->
  <header class="header">
    <div class="logo">User Permissions</div>
    <button class="logout-btn" onclick="window.location.href='/logout'">Logout</button>
  </header>

  <div class="container">
    <h1>User Permissions</h1>
    <table id="permissions-table">
      <thead>
        <tr>
          <th>Select</th>
          <th>Username</th>
          <th>Admin</th>
          <th>Editor</th>
          <th>Viewer</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rows will be dynamically populated via JavaScript -->
      </tbody>
    </table>
    <div class="button-container">
      <button id="submit-btn">Submit Changes</button>
      <button id="back-btn" onclick="window.location.href='/home'">Back</button>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="success-modal" class="modal">
    <div class="modal-content">
      <p id="success-message">Operation successful!</p>
      <button onclick="reloadPage()">OK</button>
    </div>
  </div>

  <!-- Error Modal -->
  <div id="error-modal" class="modal">
    <div class="modal-content">
      <p id="error-message">An error occurred!</p>
      <button onclick="reloadPage()">OK</button>
    </div>
  </div>

  <script>
    // Show modal
    function showModal(type, message) {
      const modal = document.getElementById(`${type}-modal`);
      const messageElement = document.getElementById(`${type}-message`);
      messageElement.textContent = message;
      modal.style.display = 'block';
    }

    // Reload page
    function reloadPage() {
      window.location.reload();
    }

    // Fetch all users and populate the table
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        const response = await fetch('/all');
        const users = await response.json();

        const tbody = document.querySelector("#permissions-table tbody");

        users.forEach(user => {
          const row = document.createElement('tr');

          row.innerHTML = `
            <td><input type="checkbox" class="user-select" data-user-id="${user.id}"></td>
            <td>${user.username}</td>
            <td><input type="checkbox" class="role-checkbox" data-user-id="${user.id}" data-role="ROLE_ADMIN" ${user.roles.some(role => role.roleName === 'ROLE_ADMIN') ? 'checked' : ''}></td>
            <td><input type="checkbox" class="role-checkbox" data-user-id="${user.id}" data-role="ROLE_EDITOR" ${user.roles.some(role => role.roleName === 'ROLE_EDITOR') ? 'checked' : ''}></td>
            <td><input type="checkbox" class="role-checkbox" data-user-id="${user.id}" data-role="ROLE_VIEWER" ${user.roles.some(role => role.roleName === 'ROLE_VIEWER') ? 'checked' : ''}></td>
            <td><button class="delete-btn" data-user-id="${user.id}">Delete</button></td>
          `;

          tbody.appendChild(row);
        });

        // Add event listeners for delete buttons
        document.querySelectorAll(".delete-btn").forEach(button => {
          button.addEventListener("click", async () => {
            const userId = button.dataset.userId;

            try {
              const response = await fetch(`/removeUser/${userId}`, {
                method: 'DELETE'
              });

              if (response.ok) {
                showModal('success', 'User deleted successfully!');
              } else {
                showModal('error', 'Error deleting user.');
              }
            } catch (error) {
              console.error('Error deleting user:', error);
              showModal('error', 'Error deleting user.');
            }
          });
        });
      } catch (error) {
        console.error('Error fetching users:', error);
        showModal('error', 'Error fetching users.');
      }
    });

    // Handle form submission
    document.querySelector("#submit-btn").addEventListener("click", async () => {
      const selectedUsers = document.querySelectorAll(".user-select:checked");
      const userRolesUpdates = [];

      selectedUsers.forEach(selectedUser => {
        const userId = selectedUser.dataset.userId;
        const roleCheckboxes = document.querySelectorAll(`.role-checkbox[data-user-id="${userId}"]`);

        roleCheckboxes.forEach(checkbox => {
          userRolesUpdates.push({
            userId: userId,
            role: checkbox.dataset.role,
            assigned: checkbox.checked
          });
        });
      });

      try {
        const response = await fetch('/update-permissions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(userRolesUpdates),
        });

        if (response.ok) {
          showModal('success', 'Permissions updated successfully!');
        } else {
          showModal('error', 'Error updating permissions.');
        }
      } catch (error) {
        console.error('Error submitting changes:', error);
        showModal('error', 'Error submitting changes.');
      }
    });
  </script>
</body>
</html>
